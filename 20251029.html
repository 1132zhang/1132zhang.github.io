<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤éŸµç´éŸ³ - é’¢ç´ç»ƒä¹ å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SimSun', 'STKaiti', serif;
            background: linear-gradient(to bottom, #f5f1e8, #e8e0d1);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><path d="M20,20 C40,10 60,10 80,20 C90,40 90,60 80,80 C60,90 40,90 20,80 C10,60 10,40 20,20 Z" fill="none" stroke="%23000" stroke-width="2"/></svg>');
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 20px;
            border: 1px solid #d4c9a8;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #d4c9a8;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            color: #8c2e0b;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 5px;
            letter-spacing: 5px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #666;
            font-style: italic;
        }

        /* é¡¶éƒ¨æ§åˆ¶é¢æ¿ */
        .top-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-panel {
            flex: 1;
            min-width: 300px;
            background-color: #f9f5eb;
            border: 2px solid #8c2e0b;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .control-title {
            font-size: 1.4rem;
            color: #8c2e0b;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid #d4c9a8;
            padding-bottom: 8px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 15px;
            background: linear-gradient(to bottom, #8c2e0b, #6d2208);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            background: linear-gradient(to bottom, #9d3f1c, #7d2f10);
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.25);
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .btn-record {
            background: linear-gradient(to bottom, #c62828, #8e0000);
        }

        .btn-record:hover {
            background: linear-gradient(to bottom, #d32f2f, #9e0000);
        }

        .btn-play {
            background: linear-gradient(to bottom, #2e7d32, #1b5e20);
        }

        .btn-play:hover {
            background: linear-gradient(to bottom, #388e3c, #2e7d32);
        }

        .btn-clear {
            background: linear-gradient(to bottom, #546e7a, #37474f);
        }

        .btn-clear:hover {
            background: linear-gradient(to bottom, #607d8b, #455a64);
        }

        .btn-tutorial {
            background: linear-gradient(to bottom, #5d4037, #3e2723);
        }

        .btn-tutorial:hover {
            background: linear-gradient(to bottom, #6d4c41, #4e342e);
        }

        .btn-help {
            background: linear-gradient(to bottom, #00695c, #004d40);
        }

        .btn-help:hover {
            background: linear-gradient(to bottom, #00796b, #00564d);
        }

        .btn-save {
            background: linear-gradient(to bottom, #1565c0, #0d47a1);
        }

        .btn-save:hover {
            background: linear-gradient(to bottom, #1976d2, #1565c0);
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #f44336;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        .record-info {
            background-color: #e8e0d1;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-top: 10px;
        }

        /* å½•éŸ³åˆ—è¡¨æ ·å¼ */
        .recordings-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d4c9a8;
            border-radius: 5px;
            background-color: #fff;
        }

        .recording-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #e8e0d1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .recording-item:hover {
            background-color: #f9f5eb;
        }

        .recording-item.active {
            background-color: #e8e0d1;
            font-weight: bold;
        }

        .recording-item:last-child {
            border-bottom: none;
        }

        .recording-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .recording-duration {
            font-size: 0.8rem;
            color: #666;
            margin-right: 10px;
        }

        .recording-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .action-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .delete-btn {
            color: #c62828;
        }

        .rename-btn {
            color: #1565c0;
        }

        /* éŸ³è‰²é€‰æ‹©å™¨æ ·å¼ */
        .tone-selector {
            margin-top: 15px;
        }

        .tone-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #8c2e0b;
        }

        .tone-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .tone-option {
            padding: 10px;
            background-color: #e8e0d1;
            border: 2px solid transparent;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tone-option:hover {
            background-color: #d4c9a8;
        }

        .tone-option.active {
            background-color: #8c2e0b;
            color: white;
            border-color: #6d2208;
        }

        /* é’¢ç´åŒºåŸŸ */
        .piano-section {
            width: 100%;
            margin-bottom: 20px;
        }

        .staff-container {
            background-color: #f9f5eb;
            border: 2px solid #8c2e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .staff {
            position: relative;
            height: 120px;
            background-color: #fff;
            border: 1px solid #aaa;
            margin-bottom: 10px;
        }

        .staff-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: #000;
        }

        .note-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #8c2e0b;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 10;
        }

        .piano-container {
            background: linear-gradient(to bottom, #111, #000);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .piano {
            display: flex;
            position: relative;
            height: 280px;
            margin: 0 auto;
            max-width: 100%;
        }

        .white-key {
            flex: 1;
            background: linear-gradient(to bottom, #fff, #f0f0f0);
            border: 1px solid #aaa;
            border-radius: 0 0 8px 8px;
            margin: 0 1px;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .white-key.active {
            background: linear-gradient(to bottom, #e0e0e0, #d0d0d0);
            transform: translateY(5px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .black-key {
            position: absolute;
            width: 60%;
            height: 65%;
            background: linear-gradient(to bottom, #333, #000);
            border-radius: 0 0 6px 6px;
            z-index: 2;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #000;
            border-top: none;
        }

        .black-key.active {
            background: linear-gradient(to bottom, #222, #111);
            transform: translateY(3px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }

        .black-key::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 0;
            width: 1px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .key-label {
            position: absolute;
            bottom: 15px;
            width: 100%;
            text-align: center;
            font-size: 1rem;
            color: #666;
            pointer-events: none;
        }

        .black-key .key-label {
            color: #ccc;
            bottom: 10px;
        }

        .current-note-display {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: #8c2e0b;
            margin-top: 10px;
            min-height: 30px;
        }

        /* ä¿¡æ¯åŒºåŸŸ */
        .info-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .instruction {
            flex: 1;
            min-width: 300px;
            background-color: #f9f5eb;
            border: 2px solid #8c2e0b;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .instruction h3 {
            color: #8c2e0b;
            margin-bottom: 10px;
            text-align: center;
        }

        .instruction p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .tutorial-section, .help-section {
            display: none;
            margin-top: 15px;
            background-color: #f9f5eb;
            border: 1px solid #d4c9a8;
            border-radius: 8px;
            padding: 15px;
        }

        .tutorial-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tutorial-selector select {
            flex: 1;
            padding: 8px;
            border: 1px solid #8c2e0b;
            border-radius: 4px;
            background-color: #fff;
            font-family: inherit;
        }

        .sheet-music {
            background-color: #fff;
            border: 1px solid #d4c9a8;
            border-radius: 4px;
            padding: 10px;
            min-height: 80px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            text-align: center;
            font-size: 1.2rem;
        }

        .finger-guide {
            background-color: #e8e0d1;
            border-radius: 4px;
            padding: 10px;
            font-size: 0.9rem;
            text-align: center;
        }

        .key-mapping {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .key-map-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            background-color: #e8e0d1;
            border-radius: 4px;
        }

        .progress-container {
            margin-top: 10px;
            background-color: #e0d9c8;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #8c2e0b, #c45a3d);
            width: 0%;
            transition: width 0.3s ease;
        }

        .help-content p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        /* æ–°å¢æ ·å¼ */
        .tutorial-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .tutorial-correct {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .tutorial-wrong {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .tutorial-complete {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .tutorial-progress {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #d4c9a8;
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .top-controls, .info-section {
                flex-direction: column;
            }
            
            .piano {
                height: 200px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .tone-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å¤éŸµç´éŸ³</h1>
            <p class="subtitle">åˆå­¦é’¢ç´ç»ƒä¹ å™¨ - èæ±‡å¤ä»Šï¼Œç´éŸµæ‚ é•¿</p>
        </header>
        
        <!-- é¡¶éƒ¨æ§åˆ¶é¢æ¿ -->
        <div class="top-controls">
            <div class="control-panel">
                <h3 class="control-title">æ¼”å¥æ§åˆ¶</h3>
                <div class="button-group">
                    <button class="btn btn-record" id="recordBtn">
                        <span class="recording-indicator" id="recordingIndicator" style="display: none;"></span>
                        å¼€å§‹å½•éŸ³
                    </button>
                    <button class="btn btn-play" id="playBtn" disabled>æ’­æ”¾å½•éŸ³</button>
                    <button class="btn btn-clear" id="clearBtn" disabled>æ¸…é™¤å½•éŸ³</button>
                    <button class="btn btn-save" id="saveBtn" disabled>ä¿å­˜å½•éŸ³</button>
                </div>
                
                <!-- éŸ³è‰²é€‰æ‹©å™¨ -->
                <div class="tone-selector">
                    <label>éŸ³è‰²é€‰æ‹©ï¼š</label>
                    <div class="tone-options">
                        <div class="tone-option active" data-tone="sine">é’¢ç´</div>
                        <div class="tone-option" data-tone="square">ç”µå­ç´</div>
                        <div class="tone-option" data-tone="sawtooth">ç®¡é£ç´</div>
                        <div class="tone-option" data-tone="triangle">å…«éŸ³ç›’</div>
                        <div class="tone-option" data-tone="bell">é“ƒé“›</div>
                        <div class="tone-option" data-tone="guitar">å‰ä»–</div>
                    </div>
                </div>
                
                <div class="record-info" id="recordInfo">å°šæœªå¼€å§‹å½•éŸ³</div>
                
                <div class="recordings-list" id="recordingsList">
                    <!-- å½•éŸ³åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <div class="control-panel">
                <h3 class="control-title">å­¦ä¹ åŠŸèƒ½</h3>
                <div class="button-group">
                    <button class="btn btn-tutorial" id="toggleTutorial">æ•™å­¦æ¨¡å¼</button>
                    <button class="btn btn-help" id="toggleHelp">ä½¿ç”¨è¯´æ˜</button>
                </div>
                
                <div class="tutorial-section" id="tutorialSection">
                    <div class="tutorial-selector">
                        <select id="tutorialSelect">
                            <option value="mary">ç›ä¸½æœ‰åªå°ç¾Šç¾”</option>
                            <option value="twinkle">å°æ˜Ÿæ˜Ÿ</option>
                            <option value="ode">æ¬¢ä¹é¢‚</option>
                        </select>
                        <button class="btn btn-tutorial" id="startTutorial">å¼€å§‹ç»ƒä¹ </button>
                    </div>
                    <div class="sheet-music" id="sheetMusic">
                        <!-- ä¹è°±å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="finger-guide" id="fingerGuide">
                        <!-- æŒ‡æ³•æŒ‡å¯¼å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="tutorial-status" id="tutorialStatus">
                        <!-- æ•™ç¨‹çŠ¶æ€å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="tutorialProgress"></div>
                    </div>
                    <div class="tutorial-progress">
                        <span id="currentProgress">0/0</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                </div>
                
                <div class="help-section" id="helpSection">
                    <div class="help-content">
                        <h3>ä½¿ç”¨è¯´æ˜</h3>
                        <p>1. ä½¿ç”¨é¼ æ ‡ç‚¹å‡»ç´é”®ã€é”®ç›˜æŒ‰é”®æˆ–è§¦æ‘¸å±è¿›è¡Œæ¼”å¥</p>
                        <p>2. ç‚¹å‡»"å¼€å§‹å½•éŸ³"æŒ‰é’®è®°å½•æ‚¨çš„æ¼”å¥</p>
                        <p>3. å½•éŸ³å®Œæˆåå¯ç‚¹å‡»"ä¿å­˜å½•éŸ³"ä¿å­˜åˆ°å½•éŸ³åˆ—è¡¨</p>
                        <p>4. ä»å½•éŸ³åˆ—è¡¨ä¸­é€‰æ‹©å½•éŸ³è¿›è¡Œæ’­æ”¾</p>
                        <p>5. äº”çº¿è°±ä¼šå®æ—¶æ˜¾ç¤ºæ‚¨æ¼”å¥çš„éŸ³ç¬¦ä½ç½®</p>
                        <p>6. é€‰æ‹©æ•™å­¦æ¨¡å¼ä¸­çš„æ›²ç›®è¿›è¡Œç»ƒä¹ </p>
                        <p>7. ä½¿ç”¨éŸ³è‰²é€‰æ‹©å™¨åˆ‡æ¢ä¸åŒçš„éŸ³è‰²æ•ˆæœ</p>
                        
                        <h3 style="margin-top: 15px;">é”®ç›˜æ˜ å°„</h3>
                        <div class="key-mapping">
                            <div class="key-map-item"><span>C</span><span>A</span></div>
                            <div class="key-map-item"><span>D</span><span>S</span></div>
                            <div class="key-map-item"><span>E</span><span>D</span></div>
                            <div class="key-map-item"><span>F</span><span>F</span></div>
                            <div class="key-map-item"><span>G</span><span>G</span></div>
                            <div class="key-map-item"><span>A</span><span>H</span></div>
                            <div class="key-map-item"><span>B</span><span>J</span></div>
                            <div class="key-map-item"><span>C5</span><span>K</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é’¢ç´åŒºåŸŸ -->
        <div class="piano-section">
            <div class="staff-container">
                <h3>äº”çº¿è°±</h3>
                <div class="staff" id="staff">
                    <!-- äº”çº¿è°±çº¿æ¡ -->
                    <div class="staff-line" style="top: 20%"></div>
                    <div class="staff-line" style="top: 35%"></div>
                    <div class="staff-line" style="top: 50%"></div>
                    <div class="staff-line" style="top: 65%"></div>
                    <div class="staff-line" style="top: 80%"></div>
                    <!-- éŸ³ç¬¦æŒ‡ç¤ºå™¨ -->
                    <div class="note-indicator" id="noteIndicator"></div>
                </div>
                <div class="current-note-display" id="currentNote">è¯·å¼€å§‹æ¼”å¥...</div>
            </div>
            
            <div class="piano-container">
                <div class="piano" id="piano">
                    <!-- é’¢ç´é”®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- ä¿¡æ¯åŒºåŸŸ -->
        <div class="info-section">
            <div class="instruction">
                <h3>é’¢ç´åŸºç¡€</h3>
                <p>é’¢ç´æœ‰88ä¸ªé”®ï¼Œåˆ†ä¸ºç™½é”®å’Œé»‘é”®ã€‚ç™½é”®ä»£è¡¨åŸºæœ¬éŸ³çº§ï¼Œé»‘é”®ä»£è¡¨å˜åŒ–éŸ³çº§ã€‚</p>
                <p>ä¸­å¤®Cä½äºé’¢ç´æ­£ä¸­å¤®ï¼Œæ˜¯åˆå­¦è€…æœ€å…ˆå­¦ä¹ çš„éŸ³ç¬¦ã€‚</p>
                <p>æ­£ç¡®çš„åå§¿å’Œæ‰‹å‹å¯¹é’¢ç´å­¦ä¹ è‡³å…³é‡è¦ã€‚</p>
            </div>
            
            <div class="instruction">
                <h3>ç»ƒä¹ å»ºè®®</h3>
                <p>1. æ¯å¤©åšæŒç»ƒä¹ 15-30åˆ†é’Ÿ</p>
                <p>2. ä»ç®€å•çš„æ›²ç›®å¼€å§‹ï¼Œé€æ­¥æé«˜éš¾åº¦</p>
                <p>3. æ³¨æ„èŠ‚å¥å’ŒéŸ³å‡†çš„å‡†ç¡®æ€§</p>
                <p>4. ä½¿ç”¨å½•éŸ³åŠŸèƒ½å›æ”¾è‡ªå·±çš„æ¼”å¥ï¼Œæ‰¾å‡ºä¸è¶³</p>
                <p>5. å°è¯•ä¸åŒéŸ³è‰²ï¼Œæ„Ÿå—éŸ³ä¹çš„å¤šæ ·æ€§</p>
            </div>
        </div>
        
        <footer>
            <p>å¤éŸµç´éŸ³ Â© 2023 - ä¸“ä¸ºé’¢ç´åˆå­¦è€…è®¾è®¡çš„ç»ƒä¹ å·¥å…·</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // é’¢ç´é…ç½®
            const pianoConfig = {
                startNote: 'C4',  // èµ·å§‹éŸ³ç¬¦
                whiteKeys: 8,     // ç™½é”®æ•°é‡
                keyMap: {
                    'A': 'C4',
                    'S': 'D4',
                    'D': 'E4',
                    'F': 'F4',
                    'G': 'G4',
                    'H': 'A4',
                    'J': 'B4',
                    'K': 'C5'
                }
            };

            // æ•™å­¦æ¨¡å¼æ•°æ®
            const tutorials = {
                mary: {
                    name: "ç›ä¸½æœ‰åªå°ç¾Šç¾”",
                    notes: ["E4", "D4", "C4", "D4", "E4", "E4", "E4", "D4", "D4", "D4", "E4", "G4", "G4"],
                    fingers: [3, 2, 1, 2, 3, 3, 3, 2, 2, 2, 3, 5, 5],
                    sheet: "E  D  C  D  E  E  E\nD  D  D  E  G  G"
                },
                twinkle: {
                    name: "å°æ˜Ÿæ˜Ÿ",
                    notes: ["C4", "C4", "G4", "G4", "A4", "A4", "G4", "F4", "F4", "E4", "E4", "D4", "D4", "C4"],
                    fingers: [1, 1, 5, 5, 4, 4, 5, 3, 3, 2, 2, 1, 1, 1],
                    sheet: "C  C  G  G  A  A  G\nF  F  E  E  D  D  C"
                },
                ode: {
                    name: "æ¬¢ä¹é¢‚",
                    notes: ["E4", "E4", "F4", "G4", "G4", "F4", "E4", "D4", "C4", "C4", "D4", "E4", "E4", "D4", "D4"],
                    fingers: [3, 3, 4, 5, 5, 4, 3, 2, 1, 1, 2, 3, 3, 2, 2],
                    sheet: "E  E  F  G  G  F  E  D\nC  C  D  E  E  D  D"
                }
            };

            // éŸ³é¢‘ä¸Šä¸‹æ–‡å’ŒæŒ¯è¡å™¨
            let audioContext;
            let oscillators = {};
            let isRecording = false;
            let recording = [];
            let recordingStartTime;
            let isTutorialActive = false;
            let tutorialNotes = [];
            let currentTutorialNote = 0;
            
            // éŸ³è‰²ç®¡ç†
            let currentTone = 'sine';
            
            // å½•éŸ³ç®¡ç†
            let recordings = [];
            let selectedRecordingId = null;
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å½•éŸ³
            function loadRecordings() {
                const savedRecordings = localStorage.getItem('pianoRecordings');
                if (savedRecordings) {
                    recordings = JSON.parse(savedRecordings);
                    updateRecordingsList();
                }
            }
            
            // ä¿å­˜å½•éŸ³åˆ°æœ¬åœ°å­˜å‚¨
            function saveRecordings() {
                localStorage.setItem('pianoRecordings', JSON.stringify(recordings));
            }
            
            // æ›´æ–°å½•éŸ³åˆ—è¡¨æ˜¾ç¤º
            function updateRecordingsList() {
                const recordingsList = document.getElementById('recordingsList');
                recordingsList.innerHTML = '';
                
                if (recordings.length === 0) {
                    recordingsList.innerHTML = '<div class="recording-item" style="justify-content: center; color: #666;">æš‚æ— å½•éŸ³</div>';
                    return;
                }
                
                recordings.forEach(rec => {
                    const recordingItem = document.createElement('div');
                    recordingItem.className = 'recording-item';
                    if (rec.id === selectedRecordingId) {
                        recordingItem.classList.add('active');
                    }
                    
                    recordingItem.innerHTML = `
                        <div class="recording-name">${rec.name}</div>
                        <div class="recording-duration">${formatDuration(rec.duration)}</div>
                        <div class="recording-actions">
                            <button class="action-btn rename-btn" title="é‡å‘½å">âœï¸</button>
                            <button class="action-btn delete-btn" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    
                    // é€‰æ‹©å½•éŸ³
                    recordingItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('action-btn')) {
                            selectRecording(rec.id);
                        }
                    });
                    
                    // é‡å‘½åå½•éŸ³
                    const renameBtn = recordingItem.querySelector('.rename-btn');
                    renameBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        renameRecording(rec.id);
                    });
                    
                    // åˆ é™¤å½•éŸ³
                    const deleteBtn = recordingItem.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteRecording(rec.id);
                    });
                    
                    recordingsList.appendChild(recordingItem);
                });
            }
            
            // é€‰æ‹©å½•éŸ³
            function selectRecording(id) {
                selectedRecordingId = id;
                updateRecordingsList();
                document.getElementById('playBtn').disabled = false;
            }
            
            // é‡å‘½åå½•éŸ³
            function renameRecording(id) {
                const recording = recordings.find(rec => rec.id === id);
                if (!recording) return;
                
                const newName = prompt('è¯·è¾“å…¥æ–°çš„å½•éŸ³åç§°ï¼š', recording.name);
                if (newName && newName.trim() !== '') {
                    recording.name = newName.trim();
                    saveRecordings();
                    updateRecordingsList();
                }
            }
            
            // åˆ é™¤å½•éŸ³
            function deleteRecording(id) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå½•éŸ³å—ï¼Ÿ')) {
                    recordings = recordings.filter(rec => rec.id !== id);
                    if (selectedRecordingId === id) {
                        selectedRecordingId = null;
                        document.getElementById('playBtn').disabled = true;
                    }
                    saveRecordings();
                    updateRecordingsList();
                }
            }
            
            // æ ¼å¼åŒ–æ—¶é•¿
            function formatDuration(milliseconds) {
                const seconds = Math.floor(milliseconds / 1000);
                return `${seconds}ç§’`;
            }
            
            // åˆå§‹åŒ–é’¢ç´
            function initPiano() {
                const piano = document.getElementById('piano');
                const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const blackKeys = ['C#', 'D#', '', 'F#', 'G#', 'A#', ''];
                
                // åˆ›å»ºç™½é”®
                for (let i = 0; i < pianoConfig.whiteKeys; i++) {
                    const whiteKey = document.createElement('div');
                    whiteKey.className = 'white-key';
                    whiteKey.dataset.note = whiteKeys[i % 7] + (4 + Math.floor(i / 7));
                    
                    // æ·»åŠ é”®ç›˜æ ‡ç­¾
                    const keyLabel = document.createElement('div');
                    keyLabel.className = 'key-label';
                    keyLabel.textContent = whiteKeys[i % 7];
                    whiteKey.appendChild(keyLabel);
                    
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    whiteKey.addEventListener('mousedown', () => playNote(whiteKey.dataset.note, whiteKey));
                    whiteKey.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        playNote(whiteKey.dataset.note, whiteKey);
                    });
                    
                    piano.appendChild(whiteKey);
                    
                    // åˆ›å»ºé»‘é”®ï¼ˆé™¤äº†Eå’ŒBä¹‹é—´æ²¡æœ‰é»‘é”®ï¼‰
                    if (blackKeys[i % 7]) {
                        const blackKey = document.createElement('div');
                        blackKey.className = 'black-key';
                        blackKey.dataset.note = blackKeys[i % 7] + (4 + Math.floor(i / 7));
                        
                        // æ·»åŠ é”®ç›˜æ ‡ç­¾
                        const blackKeyLabel = document.createElement('div');
                        blackKeyLabel.className = 'key-label';
                        blackKeyLabel.textContent = blackKeys[i % 7].replace('#', 'â™¯');
                        blackKey.appendChild(blackKeyLabel);
                        
                        // å®šä½é»‘é”®
                        blackKey.style.left = `${(i + 1) * (100 / pianoConfig.whiteKeys) - (100 / (pianoConfig.whiteKeys * 2))}%`;
                        
                        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                        blackKey.addEventListener('mousedown', () => playNote(blackKey.dataset.note, blackKey));
                        blackKey.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            playNote(blackKey.dataset.note, blackKey);
                        });
                        
                        piano.appendChild(blackKey);
                    }
                }
            }
            
            // æ’­æ”¾éŸ³ç¬¦
            function playNote(note, keyElement) {
                // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // åœæ­¢ç›¸åŒéŸ³ç¬¦çš„æŒ¯è¡å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (oscillators[note]) {
                    oscillators[note].stop();
                }
                
                // åˆ›å»ºæŒ¯è¡å™¨
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // è®¾ç½®é¢‘ç‡
                oscillator.frequency.value = getFrequency(note);
                
                // è®¾ç½®éŸ³è‰²
                oscillator.type = getOscillatorType(currentTone);
                
                // éŸ³é‡åŒ…ç»œ
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                // å¼€å§‹æ’­æ”¾
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
                
                // ä¿å­˜æŒ¯è¡å™¨å¼•ç”¨
                oscillators[note] = oscillator;
                
                // æ·»åŠ æ¿€æ´»çŠ¶æ€
                keyElement.classList.add('active');
                setTimeout(() => {
                    keyElement.classList.remove('active');
                }, 150);
                
                // æ›´æ–°äº”çº¿è°±æ˜¾ç¤º
                updateStaff(note);
                
                // è®°å½•éŸ³ç¬¦ï¼ˆå¦‚æœæ­£åœ¨å½•éŸ³ï¼‰
                if (isRecording) {
                    const elapsedTime = Date.now() - recordingStartTime;
                    recording.push({
                        note: note,
                        time: elapsedTime
                    });
                    updateRecordInfo();
                }
                
                // æ£€æŸ¥æ•™å­¦æ¨¡å¼
                if (isTutorialActive) {
                    checkTutorialNote(note);
                }
            }
            
            // è·å–æŒ¯è¡å™¨ç±»å‹
            function getOscillatorType(tone) {
                switch(tone) {
                    case 'sine': return 'sine';
                    case 'square': return 'square';
                    case 'sawtooth': return 'sawtooth';
                    case 'triangle': return 'triangle';
                    case 'bell': 
                        // é“ƒé“›éŸ³è‰²ä½¿ç”¨æ­£å¼¦æ³¢ï¼Œä½†æ·»åŠ é«˜é¢‘è°æ³¢
                        return 'sine';
                    case 'guitar':
                        // å‰ä»–éŸ³è‰²ä½¿ç”¨é”¯é½¿æ³¢ï¼Œä½†æ·»åŠ æ»¤æ³¢
                        return 'sawtooth';
                    default: return 'sine';
                }
            }
            
            // æ£€æŸ¥æ•™å­¦æ¨¡å¼ä¸­çš„éŸ³ç¬¦
            function checkTutorialNote(note) {
                const tutorialStatus = document.getElementById('tutorialStatus');
                
                if (tutorialNotes[currentTutorialNote] === note) {
                    // å¼¹å¥æ­£ç¡®
                    currentTutorialNote++;
                    updateTutorialProgress();
                    
                    tutorialStatus.textContent = `æ­£ç¡®ï¼è¯·ç»§ç»­å¼¹å¥ä¸‹ä¸€ä¸ªéŸ³ç¬¦`;
                    tutorialStatus.className = 'tutorial-status tutorial-correct';
                    
                    if (currentTutorialNote >= tutorialNotes.length) {
                        // æ•™ç¨‹å®Œæˆ
                        tutorialStatus.textContent = `æ­å–œï¼æ‚¨å·²å®Œæˆè¿™é¦–æ›²å­çš„ç»ƒä¹ ï¼`;
                        tutorialStatus.className = 'tutorial-status tutorial-complete';
                        isTutorialActive = false;
                    }
                } else {
                    // å¼¹å¥é”™è¯¯
                    tutorialStatus.textContent = `å¼¹é”™äº†ï¼è¯·å¼¹å¥ ${tutorialNotes[currentTutorialNote]} è€Œä¸æ˜¯ ${note}`;
                    tutorialStatus.className = 'tutorial-status tutorial-wrong';
                }
            }
            
            // è·å–éŸ³ç¬¦é¢‘ç‡
            function getFrequency(note) {
                const notes = {
                    'C4': 261.63,
                    'C#4': 277.18,
                    'D4': 293.66,
                    'D#4': 311.13,
                    'E4': 329.63,
                    'F4': 349.23,
                    'F#4': 369.99,
                    'G4': 392.00,
                    'G#4': 415.30,
                    'A4': 440.00,
                    'A#4': 466.16,
                    'B4': 493.88,
                    'C5': 523.25
                };
                
                return notes[note] || 440;
            }
            
            // æ›´æ–°äº”çº¿è°±æ˜¾ç¤º
            function updateStaff(note) {
                const noteIndicator = document.getElementById('noteIndicator');
                const currentNoteElement = document.getElementById('currentNote');
                
                // æ˜¾ç¤ºéŸ³ç¬¦åç§°
                currentNoteElement.textContent = `å½“å‰éŸ³ç¬¦: ${note}`;
                
                // è®¡ç®—éŸ³ç¬¦åœ¨äº”çº¿è°±ä¸Šçš„ä½ç½®
                const notePositions = {
                    'C4': 90,
                    'C#4': 85,
                    'D4': 80,
                    'D#4': 75,
                    'E4': 70,
                    'F4': 65,
                    'F#4': 60,
                    'G4': 55,
                    'G#4': 50,
                    'A4': 45,
                    'A#4': 40,
                    'B4': 35,
                    'C5': 30
                };
                
                const position = notePositions[note] || 50;
                
                // æ›´æ–°éŸ³ç¬¦æŒ‡ç¤ºå™¨ä½ç½®
                noteIndicator.style.display = 'block';
                noteIndicator.style.left = '50%';
                noteIndicator.style.top = `${position}%`;
            }
            
            // å½•éŸ³åŠŸèƒ½
            document.getElementById('recordBtn').addEventListener('click', function() {
                if (!isRecording) {
                    // å¼€å§‹å½•éŸ³
                    isRecording = true;
                    recording = [];
                    recordingStartTime = Date.now();
                    this.innerHTML = '<span class="recording-indicator" id="recordingIndicator"></span>åœæ­¢å½•éŸ³';
                    document.getElementById('recordingIndicator').style.display = 'inline-block';
                    document.getElementById('recordInfo').textContent = 'å½•éŸ³ä¸­...';
                    
                    // å¯ç”¨æ¸…é™¤æŒ‰é’®
                    document.getElementById('clearBtn').disabled = false;
                    document.getElementById('saveBtn').disabled = false;
                } else {
                    // åœæ­¢å½•éŸ³
                    isRecording = false;
                    this.innerHTML = 'å¼€å§‹å½•éŸ³';
                    document.getElementById('recordingIndicator').style.display = 'none';
                    updateRecordInfo();
                }
            });
            
            // æ’­æ”¾å½•éŸ³
            document.getElementById('playBtn').addEventListener('click', function() {
                if (!selectedRecordingId) return;
                
                const selectedRecording = recordings.find(rec => rec.id === selectedRecordingId);
                if (!selectedRecording) return;
                
                // ç¦ç”¨æŒ‰é’®
                this.disabled = true;
                document.getElementById('recordBtn').disabled = true;
                
                // æ’­æ”¾å½•éŸ³
                playRecording(selectedRecording.data, 0);
            });
            
            // æ’­æ”¾å½•éŸ³ä¸­çš„éŸ³ç¬¦
            function playRecording(recordingData, index) {
                if (index >= recordingData.length) {
                    // æ’­æ”¾å®Œæˆï¼Œé‡æ–°å¯ç”¨æŒ‰é’®
                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('recordBtn').disabled = false;
                    return;
                }
                
                const noteData = recordingData[index];
                const nextNoteTime = index < recordingData.length - 1 ? 
                    recordingData[index + 1].time - noteData.time : 500;
                
                // æ’­æ”¾å½“å‰éŸ³ç¬¦
                const keyElement = document.querySelector(`[data-note="${noteData.note}"]`);
                if (keyElement) {
                    playNote(noteData.note, keyElement);
                }
                
                // å®‰æ’æ’­æ”¾ä¸‹ä¸€ä¸ªéŸ³ç¬¦
                setTimeout(() => {
                    playRecording(recordingData, index + 1);
                }, nextNoteTime);
            }
            
            // æ¸…é™¤å½“å‰å½•éŸ³
            document.getElementById('clearBtn').addEventListener('click', function() {
                recording = [];
                document.getElementById('recordInfo').textContent = 'å½•éŸ³å·²æ¸…é™¤';
                document.getElementById('saveBtn').disabled = true;
                this.disabled = true;
            });
            
            // ä¿å­˜å½•éŸ³
            document.getElementById('saveBtn').addEventListener('click', function() {
                if (recording.length === 0) return;
                
                const recordingName = prompt('è¯·è¾“å…¥å½•éŸ³åç§°ï¼š', `å½•éŸ³ ${new Date().toLocaleString()}`);
                if (recordingName && recordingName.trim() !== '') {
                    const recordingData = {
                        id: Date.now().toString(),
                        name: recordingName.trim(),
                        data: [...recording], // åˆ›å»ºå‰¯æœ¬
                        duration: recording.length > 0 ? recording[recording.length - 1].time : 0,
                        date: new Date().toISOString()
                    };
                    
                    recordings.push(recordingData);
                    saveRecordings();
                    updateRecordingsList();
                    
                    // æ¸…é™¤å½“å‰å½•éŸ³
                    recording = [];
                    document.getElementById('recordInfo').textContent = 'å½•éŸ³å·²ä¿å­˜';
                    document.getElementById('saveBtn').disabled = true;
                    document.getElementById('clearBtn').disabled = true;
                }
            });
            
            // æ›´æ–°å½•éŸ³ä¿¡æ¯
            function updateRecordInfo() {
                if (recording.length > 0) {
                    document.getElementById('recordInfo').textContent = 
                        `å·²å½•åˆ¶ ${recording.length} ä¸ªéŸ³ç¬¦ï¼Œæ—¶é•¿ ${(recording[recording.length - 1].time / 1000).toFixed(1)} ç§’`;
                } else {
                    document.getElementById('recordInfo').textContent = 'å°šæœªå¼€å§‹å½•éŸ³';
                }
            }
            
            // é”®ç›˜äº‹ä»¶ç›‘å¬
            document.addEventListener('keydown', function(e) {
                const key = e.key.toUpperCase();
                if (pianoConfig.keyMap[key]) {
                    e.preventDefault();
                    const keyElement = document.querySelector(`[data-note="${pianoConfig.keyMap[key]}"]`);
                    if (keyElement && !keyElement.classList.contains('active')) {
                        playNote(pianoConfig.keyMap[key], keyElement);
                    }
                }
            });
            
            // éŸ³è‰²é€‰æ‹©
            document.querySelectorAll('.tone-option').forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.tone-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    
                    // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                    this.classList.add('active');
                    
                    // æ›´æ–°å½“å‰éŸ³è‰²
                    currentTone = this.dataset.tone;
                });
            });
            
            // æ•™å­¦æ¨¡å¼
            document.getElementById('startTutorial').addEventListener('click', function() {
                const tutorialId = document.getElementById('tutorialSelect').value;
                const tutorial = tutorials[tutorialId];
                
                // è®¾ç½®æ•™ç¨‹
                document.getElementById('sheetMusic').textContent = tutorial.sheet;
                document.getElementById('fingerGuide').innerHTML = 
                    `<p>æŒ‡æ³•: ${tutorial.fingers.join(' ')}</p><p>è¯·æŒ‰ç…§ä¹è°±å’ŒæŒ‡æ³•æç¤ºå¼¹å¥</p>`;
                
                tutorialNotes = tutorial.notes;
                currentTutorialNote = 0;
                isTutorialActive = true;
                
                // é‡ç½®æ•™ç¨‹çŠ¶æ€
                document.getElementById('tutorialStatus').textContent = 'è¯·å¼€å§‹å¼¹å¥ç¬¬ä¸€ä¸ªéŸ³ç¬¦';
                document.getElementById('tutorialStatus').className = 'tutorial-status';
                
                updateTutorialProgress();
            });
            
            // æ›´æ–°æ•™ç¨‹è¿›åº¦
            function updateTutorialProgress() {
                const progress = Math.round((currentTutorialNote / tutorialNotes.length) * 100);
                document.getElementById('tutorialProgress').style.width = `${progress}%`;
                document.getElementById('currentProgress').textContent = 
                    `${currentTutorialNote}/${tutorialNotes.length}`;
                document.getElementById('progressPercentage').textContent = `${progress}%`;
            }
            
            // åˆ‡æ¢æ•™å­¦æ¨¡å¼æ˜¾ç¤º
            document.getElementById('toggleTutorial').addEventListener('click', function() {
                const tutorialSection = document.getElementById('tutorialSection');
                const helpSection = document.getElementById('helpSection');
                
                if (tutorialSection.style.display === 'block') {
                    tutorialSection.style.display = 'none';
                } else {
                    tutorialSection.style.display = 'block';
                    helpSection.style.display = 'none';
                }
            });
            
            // åˆ‡æ¢ä½¿ç”¨è¯´æ˜æ˜¾ç¤º
            document.getElementById('toggleHelp').addEventListener('click', function() {
                const helpSection = document.getElementById('helpSection');
                const tutorialSection = document.getElementById('tutorialSection');
                
                if (helpSection.style.display === 'block') {
                    helpSection.style.display = 'none';
                } else {
                    helpSection.style.display = 'block';
                    tutorialSection.style.display = 'none';
                }
            });
            
            // åˆå§‹åŒ–é’¢ç´å’Œå½•éŸ³
            initPiano();
            loadRecordings();
        });
    </script>
</body>
</html>